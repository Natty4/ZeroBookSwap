{% extends "admin/base_site.html" %}

{% block content %}
<div style="max-width: 800px; margin: 20px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    <h1 style="color: #333; border-bottom: 2px solid #2196F3; padding-bottom: 10px;">
        Review Book: {{ book.title }}
    </h1>
    
    <div style="background: #f0f8ff; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
        <strong>Submitted by:</strong> {{ book.added_by.username }}<br>
        <strong>Author:</strong> {{ book.author }}<br>
        <strong>Genre:</strong> {{ book.get_genre_display }}<br>
        <strong>User's Condition:</strong> {{ book.get_condition_display }}
    </div>
    
    <form method="post" id="review-form">
        {% csrf_token %}
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Assessed Condition</label>
                <select name="assessed_condition" id="assessed_condition" style="width: 100%; padding: 8px;">
                    {% for value, label in book.BOOK_CONDITIONS %}
                    <option value="{{ value }}" {% if book.assessed_condition == value or book.condition == value %}selected{% endif %}>
                        {{ label }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Cover Type</label>
                <select name="cover_type" id="cover_type" style="width: 100%; padding: 8px;">
                    <option value="">Select</option>
                    {% for value, label in book.BOOK_COVERS %}
                    <option value="{{ value }}" {% if book.cover_type == value %}selected{% endif %}>
                        {{ label }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <div style="margin-bottom: 20px;">
            <label style="font-weight: bold; display: block; margin-bottom: 10px;">Features</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <label><input type="checkbox" name="has_images" id="has_images" {% if book.has_images %}checked{% endif %}> Has Images</label>
                <label><input type="checkbox" name="has_dust_jacket" id="has_dust_jacket" {% if book.has_dust_jacket %}checked{% endif %}> Has Dust Jacket</label>
                <label><input type="checkbox" name="is_first_edition" id="is_first_edition" {% if book.is_first_edition %}checked{% endif %}> First Edition</label>
                <label><input type="checkbox" name="is_signed" id="is_signed" {% if book.is_signed %}checked{% endif %}> Signed by Author</label>
            </div>
        </div>
        
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Review Notes</label>
            <textarea name="review_notes" id="review_notes" rows="3" style="width: 100%; padding: 8px;">{{ book.review_notes }}</textarea>
        </div>
        
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Manual ZCoin (Optional)</label>
            <input type="number" name="manual_zcoin" id="manual_zcoin" step="0.01" min="0" value="{{ book.zcoin_value|default:'' }}" style="width: 100%; padding: 8px;">
        </div>
        
        <!-- Hidden field for status -->
        <input type="hidden" name="status" value="reviewed">
        
        <!-- Single set of action buttons (NO DUPLICATES) -->
        <div style="display: flex; gap: 10px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
            <button type="submit" name="complete_review" style="background: #2196F3; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                <span>‚úì</span> Complete Review
            </button>
            <button type="button" id="calculate-btn" style="background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                <span>üßÆ</span> Calculate ZCoin
            </button>
            <button type="submit" name="save_draft" style="background: #FF9800; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                <span>üíæ</span> Save Draft
            </button>
            <a href="../../" style="padding: 10px 20px; background: #666; color: white; text-decoration: none; border-radius: 4px; display: flex; align-items: center; gap: 5px;">
                <span>‚úï</span> Cancel
            </a>
        </div>
        
        <!-- Result preview area -->
        <div id="result-preview" style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 4px; display: none;">
            <h3 style="color: #4CAF50; margin-top: 0;">Calculation Preview</h3>
            <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #ddd;">
                <span>ZCoin Value:</span>
                <span id="preview-zcoin" style="font-weight: bold; color: #4CAF50;"></span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #ddd;">
                <span>Price in Birr:</span>
                <span id="preview-price" style="font-weight: bold; color: #2196F3;"></span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                <span>Calculation Type:</span>
                <span id="preview-type"></span>
            </div>
        </div>
    </form>
</div>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');
    
    document.addEventListener('DOMContentLoaded', function() {
        const calculateBtn = document.getElementById('calculate-btn');
        const resultPreview = document.getElementById('result-preview');
        
        if (!calculateBtn) {
            console.error('Calculate button not found!');
            return;
        }
        
        calculateBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('Calculate button clicked');
            
            // Get form data
            const formData = new URLSearchParams();
            formData.append('category', '{{ book.genre }}');
            formData.append('condition', document.getElementById('assessed_condition').value);
            const coverType = document.getElementById('cover_type').value;
            if (coverType) formData.append('cover_type', coverType);
            formData.append('has_images', document.getElementById('has_images').checked);
            formData.append('has_dust_jacket', document.getElementById('has_dust_jacket').checked);
            formData.append('is_first_edition', document.getElementById('is_first_edition').checked);
            formData.append('is_signed', document.getElementById('is_signed').checked);
            const manualZcoin = document.getElementById('manual_zcoin').value;
            if (manualZcoin) formData.append('manual_zcoin', manualZcoin);
            
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            if (!csrfToken) {
                console.error('CSRF token not found!');
                alert('Security error: CSRF token missing');
                return;
            }
            
            // Show loading
            const originalHTML = calculateBtn.innerHTML;
            calculateBtn.innerHTML = '<span>‚è≥</span> Calculating...';
            calculateBtn.disabled = true;
            
            // Build the correct URL
            const bookId = {{ book.id }};
            const url = `/admin/core/book/${bookId}/calculate/`;
            console.log('Making request to:', url);
            
            // Send AJAX request to calculate endpoint
            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken
                },
                credentials: 'same-origin'
            })
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response headers:', [...response.headers.entries()]);
                
                // Check content type
                const contentType = response.headers.get('content-type');
                console.log('Content-Type:', contentType);
                
                if (!response.ok) {
                    // Try to get text to see what the error is
                    return response.text().then(text => {
                        console.error('Response text:', text);
                        throw new Error(`HTTP error! status: ${response.status}, body: ${text.substring(0, 100)}`);
                    });
                }
                
                if (!contentType || !contentType.includes('application/json')) {
                    return response.text().then(text => {
                        console.error('Non-JSON response:', text.substring(0, 200));
                        throw new Error(`Expected JSON but got: ${contentType}`);
                    });
                }
                
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Update preview
                document.getElementById('preview-zcoin').textContent = data.zcoin + ' ZCoin';
                document.getElementById('preview-price').textContent = data.price_birr + ' Birr';
                document.getElementById('preview-type').textContent = data.is_manual ? 'Manual Override' : 'Auto-calculated';
                resultPreview.style.display = 'block';
                
                // Also update the manual zcoin field with calculated value
                if (!document.getElementById('manual_zcoin').value) {
                    document.getElementById('manual_zcoin').value = data.zcoin;
                }
                
                // Show success notification
                const notification = document.createElement('div');
                notification.style.cssText = 'position:fixed;top:20px;right:20px;background:#4CAF50;color:white;padding:15px;border-radius:5px;z-index:1000;';
                notification.innerHTML = `‚úì Calculated: ${data.zcoin} ZCoin (${data.price_birr} Birr)`;
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);
                
            })
            .catch(error => {
                console.error('Fetch error:', error);
                
                // More detailed error message
                let errorMsg = 'Error calculating ZCoin: ';
                if (error.message.includes('Failed to fetch')) {
                    errorMsg += 'Network error. Please check your connection.';
                } else if (error.message.includes('Expected JSON')) {
                    errorMsg += 'Server returned non-JSON response. Check server logs.';
                } else {
                    errorMsg += error.message;
                }
                
                alert(errorMsg);
                
                // Create error notification
                const errorNotification = document.createElement('div');
                errorNotification.style.cssText = 'position:fixed;top:20px;right:20px;background:#f44336;color:white;padding:15px;border-radius:5px;z-index:1000;';
                errorNotification.innerHTML = `‚úó ${errorMsg.substring(0, 100)}`;
                document.body.appendChild(errorNotification);
                setTimeout(() => errorNotification.remove(), 5000);
            })
            .finally(() => {
                // Restore button
                calculateBtn.innerHTML = originalHTML;
                calculateBtn.disabled = false;
            });
        });
    });
</script>
{% endblock %}